<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple CapCut Lite - Clean UI</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #eee;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  h2 {
    margin-bottom: 10px;
    color: #00bcd4;
    text-align: center;
    user-select: none;
  }

  #appContainer {
    max-width: 900px;
    margin: 0 auto;
    background: #1e1e1e;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 15px rgba(0, 188, 212, 0.4);
    display: flex;
    flex-direction: column;
  }

  /* Input */
  #videoInput {
    margin-bottom: 15px;
  }

  /* Video Player */
  #videoPlayer {
    width: 100%;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0, 188, 212, 0.5);
    margin-bottom: 15px;
  }

  /* Controls container */
  #controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 25px;
  }

  button {
    background: #00bcd4;
    border: none;
    color: #121212;
    font-weight: 600;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
    user-select: none;
    box-shadow: 0 3px 8px rgba(0,188,212,0.5);
  }

  button:hover:not(:disabled) {
    background: #00acc1;
  }

  button:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
  }

  /* Timeline */
  #timelineContainer {
    background: #262626;
    padding: 15px;
    border-radius: 12px;
    box-shadow: inset 0 0 10px #000000;
    margin-bottom: 25px;
    min-height: 80px;
    overflow-x: auto;
    white-space: nowrap;
  }

  .clip {
    display: inline-flex;
    align-items: center;
    background: #00bcd4;
    color: #121212;
    padding: 8px 12px;
    border-radius: 10px;
    margin-right: 12px;
    font-weight: 600;
    user-select: none;
    position: relative;
    box-shadow: 0 3px 8px rgba(0,188,212,0.5);
  }
  .clip.mirrored {
    background: #ffc107;
  }

  .mirror-btn {
    background: #121212;
    color: #ffc107;
    border: none;
    border-radius: 6px;
    margin-left: 10px;
    padding: 4px 8px;
    font-size: 11px;
    cursor: pointer;
    font-weight: 700;
    box-shadow: inset 0 0 4px #000000;
    transition: background 0.3s ease, color 0.3s ease;
  }

  .mirror-btn:hover {
    background: #ffc107;
    color: #121212;
  }

  /* Save/Load area */
  #projectSaveLoad {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    justify-content: center;
  }

  #loadProjectInput {
    cursor: pointer;
    border-radius: 8px;
    padding: 6px 10px;
    background: #00bcd4;
    color: #121212;
    font-weight: 600;
    box-shadow: 0 3px 8px rgba(0,188,212,0.5);
    border: none;
    transition: background 0.3s ease;
  }
  #loadProjectInput:hover {
    background: #00acc1;
  }

  /* Export button & status */
  #exportBtn {
    width: 100%;
    padding: 14px;
    font-size: 18px;
    font-weight: 700;
    background: linear-gradient(90deg, #00bcd4 0%, #00acc1 100%);
    box-shadow: 0 5px 15px rgba(0,188,212,0.7);
    user-select: none;
  }

  #exportBtn:hover:not(:disabled) {
    background: linear-gradient(90deg, #00acc1 0%, #0097a7 100%);
  }

  #exportStatus {
    margin-top: 12px;
    min-height: 24px;
    text-align: center;
    font-weight: 600;
    font-style: italic;
    color: #00bcd4;
    user-select: none;
  }

  /* Responsive */
  @media (max-width: 600px) {
    #controls {
      flex-direction: column;
      gap: 10px;
    }
    button {
      width: 100%;
    }
    #projectSaveLoad {
      flex-direction: column;
      gap: 10px;
    }
    #loadProjectInput {
      width: 100%;
    }
  }
</style>
</head>
<body>

<div id="appContainer">
  <h2>Simple CapCut Lite</h2>

  <input type="file" id="videoInput" accept="video/*" multiple />

  <video id="videoPlayer" controls></video>

  <div id="controls">
    <button id="trimStartBtn">Set Trim Start</button>
    <button id="trimEndBtn">Set Trim End</button>
    <button id="addClipBtn">Add Clip to Timeline</button>
  </div>

  <h3>Timeline (click "Mirror" to toggle horizontal flip)</h3>
  <div id="timelineContainer">
    <div id="timeline"></div>
  </div>

  <div id="projectSaveLoad">
    <button id="saveProjectBtn">Save Project</button>
    <input type="file" id="loadProjectInput" title="Load Project JSON" />
  </div>

  <button id="exportBtn">Export Video</button>
  <div id="exportStatus"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.7/dist/ffmpeg.min.js"></script>
<script>
  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: true });

  const videoInput = document.getElementById('videoInput');
  const videoPlayer = document.getElementById('videoPlayer');
  const trimStartBtn = document.getElementById('trimStartBtn');
  const trimEndBtn = document.getElementById('trimEndBtn');
  const addClipBtn = document.getElementById('addClipBtn');
  const timeline = document.getElementById('timeline');
  const saveProjectBtn = document.getElementById('saveProjectBtn');
  const loadProjectInput = document.getElementById('loadProjectInput');
  const exportBtn = document.getElementById('exportBtn');
  const exportStatus = document.getElementById('exportStatus');

  let loadedVideos = [];
  let currentVideoIndex = 0;

  let trimStart = 0;
  let trimEnd = 0;

  let timelineClips = [];

  videoInput.addEventListener('change', (e) => {
    loadedVideos = [];
    timelineClips = [];
    timeline.innerHTML = '';
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const url = URL.createObjectURL(file);
      loadedVideos.push({ file, url, name: file.name });
    });
    if(loadedVideos.length > 0){
      currentVideoIndex = 0;
      loadVideo(loadedVideos[0].url);
    }
  });

  function loadVideo(url){
    videoPlayer.src = url;
    trimStart = 0;
    trimEnd = 0;
  }

  trimStartBtn.onclick = () => {
    trimStart = videoPlayer.currentTime;
    alert(`Trim start set to ${trimStart.toFixed(2)}s`);
  };

  trimEndBtn.onclick = () => {
    trimEnd = videoPlayer.currentTime;
    if(trimEnd <= trimStart){
      alert('Trim end must be greater than trim start!');
      trimEnd = 0;
      return;
    }
    alert(`Trim end set to ${trimEnd.toFixed(2)}s`);
  };

  addClipBtn.onclick = () => {
    if(trimEnd === 0) trimEnd = videoPlayer.duration;
    if(trimEnd <= trimStart){
      alert('Please set valid trim start and end!');
      return;
    }
    timelineClips.push({ videoIndex: currentVideoIndex, start: trimStart, end: trimEnd, mirror: false });
    renderTimeline();
    trimStart = 0;
    trimEnd = 0;
  };

  function renderTimeline(){
    timeline.innerHTML = '';
    timelineClips.forEach((clip, idx) => {
      const clipDiv = document.createElement('div');
      clipDiv.className = 'clip' + (clip.mirror ? ' mirrored' : '');
      const vidName = loadedVideos[clip.videoIndex].name;
      clipDiv.textContent = `${vidName}: ${clip.start.toFixed(2)}s - ${clip.end.toFixed(2)}s`;

      const mirrorBtn = document.createElement('button');
      mirrorBtn.className = 'mirror-btn';
      mirrorBtn.textContent = clip.mirror ? 'Mirrored' : 'Mirror';
      mirrorBtn.onclick = (e) => {
        e.stopPropagation();
        timelineClips[idx].mirror = !timelineClips[idx].mirror;
        renderTimeline();
      };
      clipDiv.appendChild(mirrorBtn);

      timeline.appendChild(clipDiv);
    });
  }

  saveProjectBtn.onclick = () => {
    if(loadedVideos.length === 0){
      alert('Load videos first!');
      return;
    }
    const projectData = {
      videos: loadedVideos.map(v => ({ name: v.name })),
      clips: timelineClips
    };
    const jsonStr = JSON.stringify(projectData, null, 2);
    const blob = new Blob([jsonStr], {type: "application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "capcut_project.json";
    a.click();
  };

  loadProjectInput.onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      try {
        const data = JSON.parse(evt.target.result);
        if(!data.videos || !data.clips){
          alert('Invalid project file');
          return;
        }
        alert('Project loaded. Please load videos again matching the original filenames.');
        timelineClips = data.clips;
        renderTimeline();
      } catch(e) {
        alert('Error parsing project file');
      }
    };
    reader.readAsText(file);
  };

  exportBtn.onclick = async () => {
    if(timelineClips.length === 0){
      alert('Add clips to timeline first!');
      return;
    }

    exportStatus.textContent = 'Loading FFmpeg... (this may take a while)';
    exportBtn.disabled = true;
    if(!ffmpeg.isLoaded()) {
      await ffmpeg.load();
    }

    exportStatus.textContent = 'Preparing files...';

    for(let i=0; i<loadedVideos.length; i++){
      const file = loadedVideos[i].file;
      ffmpeg.FS('writeFile', file.name, await fetchFile(file));
    }

    let trimmedFiles = [];
    for(let i=0; i<timelineClips.length; i++){
      const clip = timelineClips[i];
      const inputName = loadedVideos[clip.videoIndex].name;
      const outName = `clip${i}.mp4`;
      trimmedFiles.push(outName);

      const args = [
        '-i', inputName,
        '-ss', `${clip.start}`,
        '-to', `${clip.end}`
      ];

      if(clip.mirror) {
        args.push(
          '-vf', 'hflip',
          '-c:v', 'libx264',
          '-preset', 'fast',
          '-c:a', 'copy'
        );
      } else {
        args.push('-c', 'copy');
      }

      args.push(outName);

      exportStatus.textContent = `Processing clip ${i+1} / ${timelineClips.length} ${clip.mirror ? '(mirrored)' : ''}`;

      await ffmpeg.run(...args);
    }

    let concatFileContent = trimmedFiles.map(f => `file '${f}'`).join('\n');
    ffmpeg.FS('writeFile', 'concat_list.txt', concatFileContent);

    exportStatus.textContent = 'Merging clips...';

    await ffmpeg.run(
      '-f', 'concat',
      '-safe', '0',
      '-i', 'concat_list.txt',
      '-c', 'copy',
      'output.mp4'
    );

    exportStatus.textContent = 'Export finished! Preparing download...';

    const data = ffmpeg.FS('readFile', 'output.mp4');

    const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
    const url = URL.createObjectURL(videoBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'exported_video.mp4';
    a.click();

    exportStatus.textContent = 'Done! Your video is downloaded.';
    exportBtn.disabled = false;
  };
</script>

</body>
</html>

